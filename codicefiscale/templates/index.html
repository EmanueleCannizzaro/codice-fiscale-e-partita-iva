{% extends "base.html" %}

{% block content %}
<!-- Hero Section -->
<section class="hero-section">
    <div class="container">
        <div class="row justify-content-center text-center">
            <div class="col-lg-8">
                <h1 class="display-4 fw-bold mb-4">
                    <i class="fas fa-id-card me-3"></i>
                    Italian Fiscal Code & VAT Validation
                </h1>
                <p class="lead mb-4">
                    Validate, encode, and decode Italian fiscal codes (Codice Fiscale) and VAT numbers (Partita IVA) 
                    with our powerful web interface powered by the python-codicefiscale library.
                </p>
            </div>
        </div>
    </div>
</section>

<div class="container my-5">
    <!-- Authentication Status -->
    <div class="row justify-content-center mb-4">
        <div class="col-lg-10">
            <div class="auth-info {% if not auth_enabled %}auth-disabled{% endif %}">
                <div class="d-flex align-items-center">
                    <i class="fas fa-{% if auth_enabled %}lock{% else %}unlock{% endif %} me-3 fa-lg"></i>
                    <div>
                        <h6 class="mb-1">Authentication Status</h6>
                        <small>
                            {% if auth_enabled %}
                                <i class="fas fa-check-circle me-1"></i>
                                Authentication is <strong>enabled</strong> - API endpoints require valid JWT tokens
                                {% if user %}
                                    | Logged in as: <strong>{{ user.email or user.user_id }}</strong>
                                {% endif %}
                            {% else %}
                                <i class="fas fa-info-circle me-1"></i>
                                Authentication is <strong>disabled</strong> - All API endpoints are publicly accessible
                            {% endif %}
                        </small>
                        {% if auth_enabled and not user %}
                        <div class="mt-2">
                            <small class="text-warning">
                                <i class="fas fa-exclamation-triangle me-1"></i>
                                <strong>No active session detected.</strong> API calls from this interface may fail.
                                <br>
                                <strong>To authenticate:</strong>
                                1. Set up <a href="https://clerk.com" target="_blank" class="text-warning">Clerk authentication</a>
                                2. Get JWT token from your auth flow
                                3. Include in API requests: <code>Authorization: Bearer &lt;token&gt;</code>
                                <br>
                                <a href="https://github.com/fabiocaccamo/python-codicefiscale/blob/main/AUTHENTICATION.md" target="_blank" class="text-warning">
                                    <i class="fas fa-external-link-alt me-1"></i>View authentication setup guide
                                </a>
                            </small>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Fiscal Code Section -->
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-id-card me-2"></i>
                        Codice Fiscale (Fiscal Code)
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-4">
                        <h6>Validate Fiscal Code</h6>
                        <div class="input-group mb-3">
                            <input type="text" class="form-control" id="fiscalCodeValidate" 
                                   placeholder="e.g., CCCFBA85D03L219P" maxlength="16">
                            <button class="btn btn-primary" type="button" onclick="validateFiscalCode()">
                                <span class="spinner-border spinner-border-sm me-2 d-none" id="fiscalValidateSpinner"></span>
                                <i class="fas fa-check-circle me-1"></i>Validate
                            </button>
                        </div>
                        <div id="fiscalValidateResult"></div>
                    </div>

                    <div class="mb-4">
                        <h6>Generate Fiscal Code</h6>
                        <div class="row g-2 mb-3">
                            <div class="col-md-6">
                                <input type="text" class="form-control" id="lastName" placeholder="Last Name" required>
                            </div>
                            <div class="col-md-6">
                                <input type="text" class="form-control" id="firstName" placeholder="First Name" required>
                            </div>
                            <div class="col-md-4">
                                <select class="form-control" id="gender" required>
                                    <option value="">Gender</option>
                                    <option value="M">Male</option>
                                    <option value="F">Female</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <input type="date" class="form-control" id="birthDate" required>
                            </div>
                            <div class="col-md-4">
                                <input type="text" class="form-control" id="birthPlace" placeholder="Birth Place" required>
                            </div>
                        </div>
                        <button class="btn btn-primary w-100" onclick="encodeFiscalCode()">
                            <span class="spinner-border spinner-border-sm me-2 d-none" id="fiscalEncodeSpinner"></span>
                            <i class="fas fa-plus-circle me-1"></i>Generate Fiscal Code
                        </button>
                        <div id="fiscalEncodeResult"></div>
                    </div>

                    <div class="mb-3">
                        <h6>Decode Fiscal Code</h6>
                        <div class="input-group mb-3">
                            <input type="text" class="form-control" id="fiscalCodeDecode" 
                                   placeholder="e.g., CCCFBA85D03L219P" maxlength="16">
                            <button class="btn btn-primary" type="button" onclick="decodeFiscalCode()">
                                <span class="spinner-border spinner-border-sm me-2 d-none" id="fiscalDecodeSpinner"></span>
                                <i class="fas fa-search me-1"></i>Decode
                            </button>
                        </div>
                        <div id="fiscalDecodeResult"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- VAT Number Section -->
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-building me-2"></i>
                        Partita IVA (VAT Number)
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-4">
                        <h6>Validate VAT Number</h6>
                        <div class="input-group mb-3">
                            <input type="text" class="form-control" id="vatValidate" 
                                   placeholder="e.g., 12345678901" maxlength="11">
                            <button class="btn btn-primary" type="button" onclick="validateVat()">
                                <span class="spinner-border spinner-border-sm me-2 d-none" id="vatValidateSpinner"></span>
                                <i class="fas fa-check-circle me-1"></i>Validate
                            </button>
                        </div>
                        <div id="vatValidateResult"></div>
                    </div>

                    <div class="mb-4">
                        <h6>Generate VAT Number</h6>
                        <div class="input-group mb-3">
                            <input type="text" class="form-control" id="vatBaseNumber" 
                                   placeholder="First 10 digits (e.g., 1234567890)" maxlength="10">
                            <button class="btn btn-primary" type="button" onclick="encodeVat()">
                                <span class="spinner-border spinner-border-sm me-2 d-none" id="vatEncodeSpinner"></span>
                                <i class="fas fa-plus-circle me-1"></i>Generate VAT
                            </button>
                        </div>
                        <div id="vatEncodeResult"></div>
                    </div>

                    <div class="mb-3">
                        <h6>Decode VAT Number</h6>
                        <div class="input-group mb-3">
                            <input type="text" class="form-control" id="vatDecode" 
                                   placeholder="e.g., 12345678901" maxlength="11">
                            <button class="btn btn-primary" type="button" onclick="decodeVat()">
                                <span class="spinner-border spinner-border-sm me-2 d-none" id="vatDecodeSpinner"></span>
                                <i class="fas fa-search me-1"></i>Decode
                            </button>
                        </div>
                        <div id="vatDecodeResult"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- API Information -->
    <div class="row justify-content-center mt-5">
        <div class="col-lg-10">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        API Information
                    </h5>
                </div>
                <div class="card-body">
                    <p class="mb-3">This web interface uses the REST API endpoints. You can also access them directly:</p>
                    <div class="row">
                        <div class="col-md-6">
                            <strong>Fiscal Code Endpoints:</strong>
                            <ul class="list-unstyled mt-2">
                                <li><code>POST /fiscal-code/validate</code></li>
                                <li><code>POST /fiscal-code/encode</code></li>
                                <li><code>POST /fiscal-code/decode</code></li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <strong>VAT Number Endpoints:</strong>
                            <ul class="list-unstyled mt-2">
                                <li><code>POST /vat/validate</code></li>
                                <li><code>POST /vat/encode</code></li>
                                <li><code>POST /vat/decode</code></li>
                            </ul>
                        </div>
                    </div>
                    
                    {% if auth_enabled %}
                    <div class="alert alert-warning mt-3">
                        <h6><i class="fas fa-lock me-2"></i>Authentication Required</h6>
                        <p class="mb-2">All endpoints require a valid JWT Bearer token:</p>
                        <pre class="mb-2"><code>curl -X POST "http://localhost:8000/fiscal-code/validate" \
  -H "Authorization: Bearer &lt;your-jwt-token&gt;" \
  -H "Content-Type: application/json" \
  -d '{"code": "CCCFBA85D03L219P"}'</code></pre>
                        <small>
                            <i class="fas fa-info-circle me-1"></i>
                            See the <a href="https://github.com/fabiocaccamo/python-codicefiscale/blob/main/AUTHENTICATION.md" target="_blank">authentication setup guide</a> 
                            for complete instructions on obtaining JWT tokens.
                        </small>
                    </div>
                    {% else %}
                    <div class="alert alert-info mt-3">
                        <h6><i class="fas fa-unlock me-2"></i>No Authentication Required</h6>
                        <p class="mb-2">All endpoints are publicly accessible:</p>
                        <pre class="mb-0"><code>curl -X POST "http://localhost:8000/fiscal-code/validate" \
  -H "Content-Type: application/json" \
  -d '{"code": "CCCFBA85D03L219P"}'</code></pre>
                    </div>
                    {% endif %}
                    
                    <div class="mt-3">
                        <a href="/docs" target="_blank" class="btn btn-outline-primary me-2">
                            <i class="fas fa-book me-1"></i>Full API Documentation
                        </a>
                        <a href="/health" target="_blank" class="btn btn-outline-success me-2">
                            <i class="fas fa-heartbeat me-1"></i>Health Check
                        </a>
                        <a href="https://github.com/fabiocaccamo/python-codicefiscale/blob/main/AUTHENTICATION.md" target="_blank" class="btn btn-outline-info">
                            <i class="fas fa-key me-1"></i>Auth Setup Guide
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Global configuration
const API_BASE = '';
let authToken = null; // Will be set if authentication is enabled

// Utility functions
function showLoading(spinnerId) {
    document.getElementById(spinnerId).classList.remove('d-none');
}

function hideLoading(spinnerId) {
    document.getElementById(spinnerId).classList.add('d-none');
}

function showResult(containerId, content, isSuccess = true) {
    const container = document.getElementById(containerId);
    container.innerHTML = `<div class="result-${isSuccess ? 'success' : 'error'}">${content}</div>`;
}

function formatResult(data) {
    if (typeof data === 'object') {
        return '<pre class="mb-0">' + JSON.stringify(data, null, 2) + '</pre>';
    }
    return data;
}

async function makeApiCall(endpoint, data, spinnerId, resultId) {
    showLoading(spinnerId);
    
    const headers = {
        'Content-Type': 'application/json',
    };
    
    // Add auth header if we have a token
    if (authToken) {
        headers['Authorization'] = `Bearer ${authToken}`;
    }
    
    try {
        const response = await fetch(API_BASE + endpoint, {
            method: 'POST',
            headers: headers,
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (response.ok) {
            showResult(resultId, formatResult(result), true);
        } else {
            showResult(resultId, `Error: ${result.detail || 'Unknown error'}`, false);
        }
    } catch (error) {
        showResult(resultId, `Network Error: ${error.message}`, false);
    } finally {
        hideLoading(spinnerId);
    }
}

// Fiscal Code functions
function validateFiscalCode() {
    const code = document.getElementById('fiscalCodeValidate').value.trim();
    if (!code) {
        showResult('fiscalValidateResult', 'Please enter a fiscal code', false);
        return;
    }
    makeApiCall('/fiscal-code/validate', { code }, 'fiscalValidateSpinner', 'fiscalValidateResult');
}

function encodeFiscalCode() {
    const data = {
        lastname: document.getElementById('lastName').value.trim(),
        firstname: document.getElementById('firstName').value.trim(),
        gender: document.getElementById('gender').value,
        birthdate: document.getElementById('birthDate').value,
        birthplace: document.getElementById('birthPlace').value.trim()
    };
    
    // Validate required fields
    if (!data.lastname || !data.firstname || !data.gender || !data.birthdate || !data.birthplace) {
        showResult('fiscalEncodeResult', 'Please fill in all required fields', false);
        return;
    }
    
    makeApiCall('/fiscal-code/encode', data, 'fiscalEncodeSpinner', 'fiscalEncodeResult');
}

function decodeFiscalCode() {
    const code = document.getElementById('fiscalCodeDecode').value.trim();
    if (!code) {
        showResult('fiscalDecodeResult', 'Please enter a fiscal code', false);
        return;
    }
    makeApiCall('/fiscal-code/decode', { code }, 'fiscalDecodeSpinner', 'fiscalDecodeResult');
}

// VAT functions
function validateVat() {
    const partita_iva = document.getElementById('vatValidate').value.trim();
    if (!partita_iva) {
        showResult('vatValidateResult', 'Please enter a VAT number', false);
        return;
    }
    makeApiCall('/vat/validate', { partita_iva }, 'vatValidateSpinner', 'vatValidateResult');
}

function encodeVat() {
    const base_number = document.getElementById('vatBaseNumber').value.trim();
    if (!base_number) {
        showResult('vatEncodeResult', 'Please enter the first 10 digits', false);
        return;
    }
    if (base_number.length !== 10) {
        showResult('vatEncodeResult', 'Base number must be exactly 10 digits', false);
        return;
    }
    makeApiCall('/vat/encode', { base_number }, 'vatEncodeSpinner', 'vatEncodeResult');
}

function decodeVat() {
    const partita_iva = document.getElementById('vatDecode').value.trim();
    if (!partita_iva) {
        showResult('vatDecodeResult', 'Please enter a VAT number', false);
        return;
    }
    makeApiCall('/vat/decode', { partita_iva }, 'vatDecodeSpinner', 'vatDecodeResult');
}

// Handle Enter key in input fields
document.addEventListener('DOMContentLoaded', function() {
    // Add Enter key handlers
    document.getElementById('fiscalCodeValidate').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') validateFiscalCode();
    });
    
    document.getElementById('fiscalCodeDecode').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') decodeFiscalCode();
    });
    
    document.getElementById('vatValidate').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') validateVat();
    });
    
    document.getElementById('vatBaseNumber').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') encodeVat();
    });
    
    document.getElementById('vatDecode').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') decodeVat();
    });
    
    // Auto-uppercase fiscal codes
    const fiscalInputs = ['fiscalCodeValidate', 'fiscalCodeDecode'];
    fiscalInputs.forEach(id => {
        document.getElementById(id).addEventListener('input', function() {
            this.value = this.value.toUpperCase();
        });
    });
    
    // Only allow digits in VAT inputs
    const vatInputs = ['vatValidate', 'vatBaseNumber', 'vatDecode'];
    vatInputs.forEach(id => {
        document.getElementById(id).addEventListener('input', function() {
            this.value = this.value.replace(/\D/g, '');
        });
    });
});
</script>
{% endblock %}